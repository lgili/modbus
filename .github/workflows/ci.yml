name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build clang clang-tidy
        shell: bash
      - name: Configure (clang-tidy)
        run: cmake -S . -B build/clang-tidy -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DMODBUS_ENABLE_TESTS=ON \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_C_CLANG_TIDY=clang-tidy
        shell: bash
      - name: Run clang-tidy build
        run: cmake --build build/clang-tidy --parallel
        shell: bash

  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-gcc-debug
            os: ubuntu-latest
            preset: host-debug
            cmake_args: "-DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++"
          - name: linux-clang-asan
            os: ubuntu-latest
            preset: host-asan
            cmake_args: "-DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++"
          - name: windows-msvc
            os: windows-latest
            preset: host-debug
            cmake_args: ""
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build clang lld gcc g++ python3-pip
        shell: bash
      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3
      - name: Setup MSVC environment
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
      - name: Configure
        if: runner.os != 'Windows'
        run: cmake --preset ${{ matrix.preset }} ${{ matrix.cmake_args }}
        shell: bash
      - name: Configure (Windows)
        if: runner.os == 'Windows'
        run: cmake --preset ${{ matrix.preset }} ${{ matrix.cmake_args }}
        shell: pwsh
      - name: Build
        if: runner.os != 'Windows'
        run: cmake --build --preset ${{ matrix.preset }}
        shell: bash
      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cmake --build --preset ${{ matrix.preset }}
        shell: pwsh
      - name: Run tests
        if: runner.os != 'Windows'
        run: ctest --output-on-failure --test-dir build/${{ matrix.preset }}
        shell: bash
      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        run: ctest --output-on-failure --test-dir build/${{ matrix.preset }}
        shell: pwsh

  coverage:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Install coverage toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build gcc g++ lcov
        shell: bash
      - name: Configure coverage preset
        run: cmake --preset host-coverage -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
        shell: bash
      - name: Generate coverage report
        run: cmake --build --preset host-coverage --target coverage
        shell: bash
      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: build/host-coverage/coverage_html
        if: success()

  fuzz:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Install fuzzing toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build clang llvm
          CLANG_MAJ=$(clang -dumpversion | cut -d. -f1)
          set +e
          success_pkg=0
          for ver in "$CLANG_MAJ" 19 18 17 16 15 14; do
            if sudo apt-get install -y "libclang-rt-${ver}-dev"; then
              echo "Installed libclang-rt-${ver}-dev"
              success_pkg=1
              break
            fi
          done
          set -e
          if [ "$success_pkg" -ne 1 ]; then
            echo "::error::Failed to install a compatible libclang-rt runtime package" >&2
            exit 1
          fi
        shell: bash
      - name: Configure fuzz preset
        run: cmake --preset host-fuzz -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
        shell: bash
      - name: Build fuzzers
        run: cmake --build --preset host-fuzz --target modbus_pdu_fuzz
        shell: bash
      - name: Smoke test fuzz target
        run: build/host-fuzz/fuzz/modbus_pdu_fuzz -runs=1000 -seed=1337
        shell: bash

  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3
      - name: Install documentation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install sphinx breathe sphinx-rtd-theme
        shell: bash
      - name: Configure docs preset
        run: cmake --preset host-docs
        shell: bash
      - name: Build documentation
        run: cmake --build --preset docs
        shell: bash
      - name: Deploy GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/docs/html
          publish_branch: gh-pages
          force_orphan: true

  tcp-integration:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Install integration dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build gcc g++ clang git cmake build-essential libmodbus-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install pymodbus==2.5.3 modpoll
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        shell: bash
      - name: Configure project (host-debug-examples)
        run: cmake --preset host-debug-examples
        shell: bash
      - name: Build TCP client CLI
        run: cmake --build --preset host-debug-examples --target modbus_tcp_client_cli
        shell: bash
      - name: Verify modpoll installation
        run: modpoll --version
        shell: bash
      - name: Start Modbus TCP server
        run: |
          python3 scripts/ci/modbus_tcp_server.py &
          echo $! > server.pid
          sleep 3
        shell: bash
      - name: Run library client against server
        run: build/host-debug-examples/examples/modbus_tcp_client_cli --host 127.0.0.1 --port 15020 --unit 1 --register 0 --count 2 --expect 100,200
        shell: bash
      - name: Validate with pymodbus client
        run: |
          python3 - <<'PY'
          from pymodbus.client.sync import ModbusTcpClient

          client = ModbusTcpClient("127.0.0.1", port=15020)
          if not client.connect():
              raise SystemExit("Failed to connect to Modbus TCP server")

          response = client.read_holding_registers(address=0, count=2, unit=1)
          client.close()

          if response.isError():
              raise SystemExit(f"Modbus read failed: {response}")

          expected = [100, 200]
          if response.registers != expected:
              raise SystemExit(f"Unexpected register values: {response.registers} != {expected}")
          PY
        shell: bash
      - name: Validate with modpoll
        run: |
          modpoll -m tcp -a 1 -r 0 -c 2 127.0.0.1 -p 15020 | tee /tmp/modpoll.log
          grep -q "100" /tmp/modpoll.log
          grep -q "200" /tmp/modpoll.log
        shell: bash
      - name: Stop Modbus TCP server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill "$(cat server.pid)" || true
          fi
        shell: bash
